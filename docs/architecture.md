# アーキテクチャ設計

## 全体構成

本人確認システムは、以下のレイヤーで構成されます：

1. **プレゼンテーション層**：ユーザーインターフェースとUIロジック
2. **アプリケーション層**：ユースケースの実装
3. **ドメイン層**：ビジネスロジックとドメインモデル
4. **インフラストラクチャ層**：データ永続化、外部サービスへのアクセス

各レイヤーは明確に分離し、依存方向は内側（ドメイン層）に向かうように設計します。

## ドメインモデル

本システムの中心となるドメインモデルは以下の通りです：

### エンティティ
- **User**: システムを利用するユーザー（一般ユーザーと管理者）
- **VerificationImage**: 本人確認のために撮影・提出された画像
- **VerificationRequest**: 本人確認リクエスト（ステータス管理を含む）

### 値オブジェクト
- **UserId**: ユーザーを識別するID
- **ImageId**: 画像を識別するID
- **NumericId**: 数値型のID（非負整数）。データベースの自動採番IDなどに使用
- **VerificationStatus**: 本人確認のステータス（未確認、承認済み、拒否）
- **UserRole**: ユーザーの役割（一般ユーザー、管理者）

### リポジトリ
- **UserRepository**: ユーザー情報の永続化
- **VerificationImageRepository**: 画像データの永続化
- **VerificationRequestRepository**: 本人確認リクエストの永続化

## アプリケーションの機能

### 認証機能
- Googleアカウントを利用した認証
- ユーザー権限管理（一般/管理者）

### 本人確認画像撮影機能
- PCカメラを使用した画像撮影
- 画像のプレビュー表示
- 撮影画像の保存とメタデータ記録

### データ管理機能
- 管理者向け画像一覧表示
- 画像の承認/拒否処理
- 検索・フィルタリング機能

## 技術構成

### フロントエンド
- **Next.js**: ページルーティングとレンダリング
- **Tailwind CSS**: スタイリング
- **shadcn/ui**: UIコンポーネント
- **React**: UIの構築

### バックエンド
- **Next.js API Routes**: サーバーサイドロジック
- **Prisma**: データベースアクセス
- **SQLite**: データ永続化

### テスト
- **Jest**: ユニットテストとインテグレーションテスト
- **React Testing Library**: UIコンポーネントのテスト
- **MSW (Mock Service Worker)**: APIモック
- **Playwright**: E2Eテスト
- **Storybook**: UIコンポーネントの開発とビジュアルテスト

## セキュリティ

- 画像データの暗号化保存
- 認証・認可の厳格な実装
- CSRFトークンの使用
- Content Security Policyの適用

## UI/UX設計方針
### 情報設計
- **画面構成設計**
  - 明確な画面遷移フローの定義
  - 各画面の役割と責務の明確化
  - モバイルファーストの設計アプローチ
- **情報アーキテクチャ**
  - ユーザーフローに基づく情報の構造化
  - 必要な情報の整理と優先順位付け
  - アクセシビリティを考慮した情報設計

### UIコンポーネント設計
- **コンポーネント階層**
  - 再利用可能なコンポーネントの特定
  - プレゼンテーションとコンテナコンポーネントの分離
  - コンポーネント間の依存関係の明確化
- **デザインシステム**
  - shadcn/uiを基盤としたUIコンポーネントの統一
  - アプリケーション固有のコンポーネントの設計指針
  - アクセシビリティ要件の組み込み

### インタラクション設計
- **ユーザー操作フロー**
  - 直感的な操作性の確保
  - エラー時のフィードバック設計
  - プログレッシブエンハンスメントの考慮
- **アクセシビリティ**
  - WAI-ARIAガイドラインの遵守
  - キーボード操作のサポート
  - スクリーンリーダー対応

## テスト戦略
### テストレベル
- **ユニットテスト**
  - ドメインモデルのテスト
  - 値オブジェクトのテスト
  - UIコンポーネントの単体テスト
- **インテグレーションテスト**
  - リポジトリの結合テスト
  - APIエンドポイントの結合テスト
  - コンポーネント間の結合テスト
- **E2Eテスト**
  - 主要ユースケースのシナリオテスト
  - クリティカルパスの検証
  - ブラウザ互換性テスト

### テスト環境
- **開発環境**
  - Jest + React Testing Library
  - MSW（APIモック）
  - Playwright（E2Eテスト）
- **テストデータ**
  - テスト用データベース
  - シードデータの準備
  - テストフィクスチャの管理

### テスト自動化
- **CI/CDパイプライン**
  - プルリクエスト時の自動テスト実行
  - E2Eテストの定期実行
  - カバレッジレポートの生成

## 展開方針

システムはフェーズ分けして開発を進めます：

1. **Phase 1**: 本人確認画像撮影・保存機能
   - 基本的なデータ構造とAPI実装
   - UI/UX設計
   - フロントエンド基本実装
   - 本人確認ワークフロー実装
   - パフォーマンス最適化とエラーハンドリング
2. **Phase 2**: 管理者ダッシュボード
3. **Phase 3**: 認証システム

各フェーズでは動作するMVPを目指し、イテレーティブに開発を進めます。
各フェーズにおいて、設計・実装・テストを一体として進め、品質を確保します。